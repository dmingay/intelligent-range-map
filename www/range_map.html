<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Polestar 4 — Intelligent Range Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #0a0e17;
    font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
    color: #e0e6f0;
  }

  .page-wrapper {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
  }

  #map {
    width: 100%;
    flex: 1 1 auto;
    min-height: 0;
    position: relative;
    z-index: 1;
  }

  .bottom-bar {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    gap: 0;
    background: rgba(10, 14, 23, 0.96);
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    padding: 12px 24px;
    z-index: 10;
  }

  .info-section {
    display: flex;
    align-items: center;
    gap: 20px;
    flex: 1 1 auto;
    min-width: 0;
  }

  .title-block {
    display: flex;
    align-items: center;
    gap: 14px;
    flex-shrink: 0;
  }

  .car-icon {
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, #00e5ff, #7c4dff);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
  }

  .title-block h2 {
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.3px;
    color: #ffffff;
    line-height: 1.2;
  }

  .title-block .subtitle {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.4);
    font-weight: 400;
  }

  .range-block {
    display: flex;
    align-items: baseline;
    gap: 5px;
    flex-shrink: 0;
    padding: 0 16px;
    border-left: 1px solid rgba(255, 255, 255, 0.08);
    border-right: 1px solid rgba(255, 255, 255, 0.08);
  }

  .range-value {
    font-size: 32px;
    font-weight: 700;
    line-height: 1;
    background: linear-gradient(135deg, #00e5ff 0%, #7c4dff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .range-unit {
    font-size: 14px;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.5);
  }

  .range-miles {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.3);
    margin-left: 2px;
  }

  .stats-row {
    display: flex;
    gap: 14px;
    flex-shrink: 0;
  }

  .stat {
    background: rgba(255, 255, 255, 0.04);
    border-radius: 8px;
    padding: 6px 10px;
    text-align: center;
  }

  .stat-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: rgba(255, 255, 255, 0.35);
    margin-bottom: 2px;
  }

  .stat-value {
    font-size: 14px;
    font-weight: 600;
    color: #ffffff;
  }

  .stat-value.soc { color: #00e5ff; }
  .stat-value.soh { color: #00e676; }
  .stat-value.temp { color: #ffab40; }
  .stat-value.wind { color: #80cbc4; }

  .legend-section {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
    padding-left: 16px;
    border-left: 1px solid rgba(255, 255, 255, 0.08);
  }

  .legend-section h3 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: rgba(255, 255, 255, 0.35);
    font-weight: 500;
    white-space: nowrap;
  }

  .legend-items {
    display: flex;
    gap: 12px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    white-space: nowrap;
  }

  .legend-swatch {
    width: 14px;
    height: 7px;
    border-radius: 2px;
    flex-shrink: 0;
    opacity: 0.8;
  }

  .legend-label { color: rgba(255, 255, 255, 0.6); }
  .legend-range {
    font-weight: 600;
    color: rgba(255, 255, 255, 0.85);
    font-variant-numeric: tabular-nums;
  }

  .timestamp-section {
    flex-shrink: 0;
    padding-left: 16px;
    border-left: 1px solid rgba(255, 255, 255, 0.08);
    text-align: right;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .ts-time {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.4);
  }

  .ts-method {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.2);
    margin-top: 2px;
  }

  .loading-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 2000;
    background: rgba(10, 14, 23, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 0.5s ease;
  }

  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top-color: #00e5ff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 16px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.4);
    letter-spacing: 0.5px;
  }

  .fullscreen-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 1000;
    width: 40px;
    height: 40px;
    background: rgba(10, 14, 23, 0.85);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 8px;
    color: rgba(255, 255, 255, 0.7);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  .fullscreen-btn:hover {
    background: rgba(0, 229, 255, 0.15);
    border-color: rgba(0, 229, 255, 0.3);
    color: #00e5ff;
  }

  .fullscreen-btn:active { transform: scale(0.95); }

  body.is-fullscreen .bottom-bar {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    background: rgba(10, 14, 23, 0.88);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  body.is-fullscreen #map { height: 100vh !important; }
  body.is-fullscreen .page-wrapper { position: relative; }

  .leaflet-control-zoom { display: none !important; }
  .leaflet-control-attribution {
    background: rgba(10, 14, 23, 0.6) !important;
    color: rgba(255, 255, 255, 0.25) !important;
    font-size: 10px !important;
    border-radius: 6px 0 0 0 !important;
  }
  .leaflet-control-attribution a { color: rgba(255, 255, 255, 0.35) !important; }

  .vehicle-marker { width: 20px; height: 20px; position: relative; }

  .vehicle-marker .core {
    width: 14px; height: 14px;
    background: #ffffff;
    border-radius: 50%;
    position: absolute; top: 3px; left: 3px;
    box-shadow: 0 0 12px rgba(0, 229, 255, 0.6);
    z-index: 2;
  }

  .vehicle-marker .pulse {
    width: 20px; height: 20px;
    background: rgba(0, 229, 255, 0.25);
    border-radius: 50%;
    position: absolute; top: 0; left: 0;
    animation: pulse-ring 2s ease-out infinite;
  }

  @keyframes pulse-ring {
    0% { transform: scale(1); opacity: 0.6; }
    100% { transform: scale(3); opacity: 0; }
  }

  @media (max-width: 1000px) {
    .bottom-bar { flex-wrap: wrap; gap: 14px; padding: 10px 14px; }
    .info-section { flex-basis: 100%; }
    .legend-section { border-left: none; padding-left: 0; }
    .timestamp-section { border-left: none; padding-left: 0; margin-left: auto; }
  }

  @media (max-width: 600px) {
    .stats-row { display: none; }
    .range-value { font-size: 26px; }
    .legend-items { flex-wrap: wrap; gap: 8px; }
  }
</style>
</head>
<body>

<div class="page-wrapper">
  <div id="map"></div>
  <button class="fullscreen-btn" id="fullscreenBtn" title="Toggle fullscreen">&#x26F6;</button>

  <div class="bottom-bar">
    <div class="info-section">
      <div class="title-block">
        <div class="car-icon">&#9889;</div>
        <div>
          <h2>Polestar 4</h2>
          <div class="subtitle">Intelligent Range</div>
        </div>
      </div>

      <div class="range-block">
        <span class="range-value" id="rangeKm">&mdash;</span>
        <span class="range-unit">mi</span>
        <span class="range-miles" id="rangeMiles">&mdash; mi</span>
      </div>

      <div class="stats-row">
        <div class="stat">
          <div class="stat-label">Charge</div>
          <div class="stat-value soc" id="statSoc">&mdash;%</div>
        </div>
        <div class="stat">
          <div class="stat-label">Health</div>
          <div class="stat-value soh" id="statSoh">&mdash;%</div>
        </div>
        <div class="stat">
          <div class="stat-label">Temp</div>
          <div class="stat-value temp" id="statTemp">&mdash;&deg;C</div>
        </div>
        <div class="stat">
          <div class="stat-label">Wind</div>
          <div class="stat-value wind" id="statWind">&mdash; m/s</div>
        </div>
      </div>
    </div>

    <div class="legend-section" id="legend">
      <h3>Bands</h3>
      <div class="legend-items" id="legendItems"></div>
    </div>

    <div class="timestamp-section" id="timestamp">
      <div class="ts-time">Loading&hellip;</div>
      <div class="ts-method"></div>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Calculating range contours&hellip;</div>
</div>

<script>
(function() {
  'use strict';

  var map = L.map('map', {
    zoomControl: false,
    attributionControl: true,
    preferCanvas: true
  }).setView([51.3656, -0.4139], 10);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://carto.com/">CARTO</a> &copy; <a href="https://osm.org/copyright">OSM</a>',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);

  var rangeGroup = L.featureGroup().addTo(map);
  var vehicleMarker = null;

  var bandStyles = {
    '100%': { color: '#00e5ff', fillOpacity: 0.12, weight: 1.5, opacity: 0.6 },
    '75%':  { color: '#00b0ff', fillOpacity: 0.14, weight: 1.5, opacity: 0.6 },
    '50%':  { color: '#2979ff', fillOpacity: 0.16, weight: 1.5, opacity: 0.6 },
    '25%':  { color: '#7c4dff', fillOpacity: 0.20, weight: 1.5, opacity: 0.6 }
  };

  // Fullscreen toggle — desktop only, hidden on mobile/iframe
  var fsBtn = document.getElementById('fullscreenBtn');
  var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  var isMobile = /Mobi|Android/i.test(navigator.userAgent);
  var isInIframe = (window !== window.top);

  if (isIOS || isMobile || isInIframe) {
    fsBtn.style.display = 'none';
  }

  fsBtn.addEventListener('click', function() {
    var doc = document.documentElement;
    if (!document.fullscreenElement && !document.webkitFullscreenElement) {
      if (doc.requestFullscreen) {
        doc.requestFullscreen();
      } else if (doc.webkitRequestFullscreen) {
        doc.webkitRequestFullscreen();
      }
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      }
    }
  });

  function onFsChange() {
    var isFull = !!(document.fullscreenElement || document.webkitFullscreenElement);
    document.body.classList.toggle('is-fullscreen', isFull);
    fsBtn.innerHTML = isFull ? '&#x2716;' : '&#x26F6;';
    setTimeout(function() { map.invalidateSize(); }, 100);
  }
  document.addEventListener('fullscreenchange', onFsChange);
  document.addEventListener('webkitfullscreenchange', onFsChange);

  function loadData() {
    var ts = Date.now();

    Promise.all([
      fetch('/local/ev_range/range_contour.json?v=' + ts).then(function(r) {
        if (!r.ok) throw new Error('Contour: ' + r.status);
        return r.json();
      }),
      fetch('/local/ev_range/range_metadata.json?v=' + ts).then(function(r) {
        if (!r.ok) throw new Error('Metadata: ' + r.status);
        return r.json();
      })
    ])
    .then(function(results) {
      var geojson = results[0];
      var meta = results[1];
      console.log('[EV Range] Features:', geojson.features ? geojson.features.length : 0);
      renderMap(geojson, meta);
      document.getElementById('loadingOverlay').classList.add('hidden');
    })
    .catch(function(err) {
      console.error('[EV Range] Load failed:', err);
      document.getElementById('loadingOverlay').classList.add('hidden');
    });
  }

  function renderMap(geojson, meta) {
    rangeGroup.clearLayers();
    if (vehicleMarker) {
      map.removeLayer(vehicleMarker);
      vehicleMarker = null;
    }

    var bandFeatures = [];
    var vehicleCoords = null;

    geojson.features.forEach(function(f) {
      if (f.properties.type === 'vehicle') {
        vehicleCoords = f.geometry.coordinates;
      } else {
        bandFeatures.push(f);
      }
    });

    bandFeatures.forEach(function(f) {
      var band = f.properties.band;
      var style = bandStyles[band] || { color: '#ffffff', fillOpacity: 0.1, weight: 1, opacity: 0.5 };

      try {
        L.geoJSON(f, {
          style: {
            color: style.color,
            fillColor: style.color,
            fillOpacity: style.fillOpacity,
            weight: style.weight,
            opacity: style.opacity
          }
        }).addTo(rangeGroup);
      } catch (e) {
        console.error('[EV Range] Band ' + band + ' error:', e);
      }
    });

    if (vehicleCoords) {
      var icon = L.divIcon({
        className: '',
        html: '<div class="vehicle-marker"><div class="pulse"></div><div class="core"></div></div>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      vehicleMarker = L.marker([vehicleCoords[1], vehicleCoords[0]], { icon: icon }).addTo(map);
    }

    if (rangeGroup.getLayers().length > 0) {
      map.fitBounds(rangeGroup.getBounds().pad(0.08));
    }

    updateInfoPanel(meta);
    updateLegend(meta);
    updateTimestamp(meta);
  }

  function updateInfoPanel(meta) {
    var range = meta.range || {};
    document.getElementById('rangeKm').textContent = range.intelligent_range_miles != null ? range.intelligent_range_miles : '\u2014';
    document.getElementById('rangeMiles').textContent = (range.intelligent_range_km != null ? range.intelligent_range_km : '\u2014') + ' km';

    var v = meta.vehicle || {};
    document.getElementById('statSoc').textContent = (v.soc_pct != null ? v.soc_pct : '\u2014') + '%';
    document.getElementById('statSoh').textContent = (v.soh_pct != null ? v.soh_pct : '\u2014') + '%';

    var w = meta.weather || {};
    document.getElementById('statTemp').textContent = (w.temp_c != null ? w.temp_c.toFixed(1) : '\u2014') + '\u00B0C';
    document.getElementById('statWind').textContent = (w.wind_ms != null ? w.wind_ms.toFixed(1) : '\u2014') + ' m/s';
  }

  function updateLegend(meta) {
    var el = document.getElementById('legendItems');
    var bands = (meta.range && meta.range.bands) || [];

    var html = '';
    bands.forEach(function(b) {
      var dim = b.has_polygon ? '' : ' style="opacity:0.35"';
      html += '<div class="legend-item"' + dim + '>' +
        '<div class="legend-swatch" style="background:' + b.color + '"></div>' +
        '<span class="legend-label">' + b.label + '</span>' +
        '<span class="legend-range">' + (b.has_polygon ? b.range_miles + ' mi' : '\u2014') + '</span>' +
        '</div>';
    });
    el.innerHTML = html;
  }

  function updateTimestamp(meta) {
    var el = document.getElementById('timestamp');
    var calc = meta.calculation || {};
    var ts = meta.timestamp ? new Date(meta.timestamp) : null;
    var timeStr = ts ? ts.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '\u2014';
    var dateStr = ts ? ts.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';

    el.innerHTML = '<div class="ts-time">Updated ' + timeStr + ' \u00B7 ' + dateStr + '</div>' +
      '<div class="ts-method">' + (calc.method || 'v3') + ' \u00B7 ' + (calc.duration_seconds != null ? calc.duration_seconds : '?') + 's</div>';
  }

  loadData();
  setInterval(loadData, 5 * 60 * 1000);
  window.addEventListener('resize', function() { map.invalidateSize(); });

})();
</script>
</body>
</html>
